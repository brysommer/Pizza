import { driversBot } from "../app.js";
import qrcode from 'qrcode';

export const referalProgram = () => {
    driversBot.setMyCommands([
        {command: '/referal', description: '–ó–∞–ø—Ä–æ—à—É–≤–∞–ª—å–Ω–µ –ø–æ—Å–∏–ª–∞–Ω–Ω—è'},
    ]);
    
    // –ü—Ä–∏–∫–ª–∞–¥ –≤—ñ–¥–ø–æ–≤—ñ–¥—ñ –Ω–∞ –∫–æ–º–∞–Ω–¥—É /referal
    driversBot.onText(/\/referal/, async (msg) => {
        const chatId = msg.chat.id;
        const referralLink = `https://t.me/che\\_go\\_bot?start=${chatId}`; // –ó–∞–º—ñ–Ω—ñ—Ç—å –Ω–∞ –≤–∞—à–µ —Ñ–∞–∫—Ç–∏—á–Ω–µ —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω–µ –ø–æ—Å–∏–ª–∞–Ω–Ω—è

        const message = `ü§ù **–ó–∞–ø—Ä–æ—à—É–π –¥—Ä—É–∑—ñ–≤ —Ç–∞ –æ—Ç—Ä–∏–º—É–π –±–æ–Ω—É—Å–∏!**\n\n` +
                        `–ü–æ–¥—ñ–ª–∏—Å—å —Ü–∏–º –ø–æ—Å–∏–ª–∞–Ω–Ω—è–º –∑—ñ —Å–≤–æ—ó–º–∏ –∑–Ω–∞–π–æ–º–∏–º–∏ –∑–∞–∫–ª–∞–¥–∞–º–∏, —ñ –∫–æ–ª–∏ –≤–æ–Ω–∏ –∑–∞—Ä–µ—î—Å—Ç—Ä—É—é—Ç—å—Å—è —Ç–∞ –≤–∏–∫–æ–Ω–∞—é—Ç—å –ø–µ—Ä—à–µ –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è, —Ç–∏ –æ—Ç—Ä–∏–º–∞—î—à –≤–∏–Ω–∞–≥–æ—Ä–æ–¥—É!\n\n` +
                        `üîó –û—Å—å —Ç–≤–æ—î –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω–µ –∑–∞–ø—Ä–æ—à—É–≤–∞–ª—å–Ω–µ –ø–æ—Å–∏–ª–∞–Ω–Ω—è:\n` +
                        `${referralLink}\n\n` +
                        `–î—è–∫—É—î–º–æ, —â–æ –¥–æ–ø–æ–º–∞–≥–∞—î—à —Ä–æ–∑—à–∏—Ä—é–≤–∞—Ç–∏ –Ω–∞—à—É —Å–ø—ñ–ª—å–Ω–æ—Ç—É! ‚ú®`;

        driversBot.sendMessage(chatId, message, { parse_mode: 'Markdown' });

        try {
            // –ì–µ–Ω–µ—Ä—É—î–º–æ QR-–∫–æ–¥ —è–∫ –±—É—Ñ–µ—Ä (Buffer) –∑ –∑–æ–±—Ä–∞–∂–µ–Ω–Ω—è–º
            const qrCodeBuffer = await qrcode.toBuffer(`https://t.me/che_go_bot?start=${chatId}`, {
                errorCorrectionLevel: 'H', // –†—ñ–≤–µ–Ω—å –∫–æ—Ä–µ–∫—Ü—ñ—ó –ø–æ–º–∏–ª–æ–∫ (H = High)
                type: 'png', // –¢–∏–ø –∑–æ–±—Ä–∞–∂–µ–Ω–Ω—è
                width: 300 // –®–∏—Ä–∏–Ω–∞ QR-–∫–æ–¥—É
            });
    
            // –í—ñ–¥–ø—Ä–∞–≤–ª—è—î–º–æ QR-–∫–æ–¥ —è–∫ —Ñ–æ—Ç–æ
            await driversBot.sendPhoto(chatId, qrCodeBuffer, {
                caption: '–¢–≤—ñ–π QR-–∫–æ–¥ –¥–ª—è –∑–∞–ø—Ä–æ—à–µ–Ω–Ω—è –¥—Ä—É–∑—ñ–≤!'
            });
    
        } catch (err) {
            console.error('–ü–æ–º–∏–ª–∫–∞ –ø—Ä–∏ –≥–µ–Ω–µ—Ä–∞—Ü—ñ—ó –∞–±–æ –≤—ñ–¥–ø—Ä–∞–≤–ª–µ–Ω–Ω—ñ QR-–∫–æ–¥—É:', err);
            driversBot.sendMessage(chatId, '–í–∏–Ω–∏–∫–ª–∞ –ø–æ–º–∏–ª–∫–∞ –ø—Ä–∏ –≥–µ–Ω–µ—Ä–∞—Ü—ñ—ó QR-–∫–æ–¥—É. –°–ø—Ä–æ–±—É–π—Ç–µ –ø—ñ–∑–Ω—ñ—à–µ.');
        }
    }); 
}

